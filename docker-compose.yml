services:
  traefik:
    image: traefik:v3.4
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "8080:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:9.1
    ports:
      - "18888:18888"
    environment:
      DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS: "true"

  backend:
    build:
      context: ./src/ZettelWeb
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      ConnectionStrings__DefaultConnection: "Host=db;Database=zettelweb;Username=zettel;Password=zettel_dev"
      Otel__Endpoint: "http://aspire-dashboard:18889"
      Embedding__Provider: "${EMBEDDING_PROVIDER:-ollama}"
      Embedding__ApiKey: "${EMBEDDING_API_KEY:-}"
      Embedding__Model: "${EMBEDDING_MODEL:-nomic-embed-text}"
      Embedding__OllamaUrl: "${EMBEDDING_OLLAMA_URL:-http://host.docker.internal:11434}"
      Capture__SqsQueueUrl: ${CAPTURE_SQS_QUEUE_URL:-}
      Capture__SqsRegion: "eu-west-1"
      Capture__AllowedEmailSenders__0: ${CAPTURE_ALLOWED_EMAIL_SENDERS_0:-}
      Capture__AllowedTelegramChatIds__0: ${CAPTURE_ALLOWED_TELEGRAM_CHAT_IDS_0:-}
      Capture__TelegramBotToken: ${TELEGRAM_BOT_TOKEN:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      Publishing__GitHub__Token: ${GITHUB_PAT:-}
      Publishing__GitHub__Owner: "jeastham1993"
      Publishing__GitHub__Repo: "James-Eastham-Blog"
      Publishing__GitHub__Branch: "main"
      Publishing__GitHub__ContentPath: "drafts"
      Publishing__GitHub__Author: "James Eastham"
      Publishing__Publer__ApiKey: ${PUBLER_API_KEY:-}
      Publishing__Publer__Accounts__0__Id: "659070ccdb27974e47d908f5"
      Publishing__Publer__Accounts__0__Platform: "linkedin"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=PathPrefix(`/api`) || PathPrefix(`/health`)"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.routers.backend.priority=100"
      - "traefik.http.services.backend.loadbalancer.server.port=8080"
    depends_on:
      db:
        condition: service_healthy

  frontend:
    build:
      context: ./src/zettel-web-ui
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.priority=1"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
    depends_on:
      - backend

  db:
    image: pgvector/pgvector:pg17
    environment:
      POSTGRES_DB: zettelweb
      POSTGRES_USER: zettel
      POSTGRES_PASSWORD: zettel_dev
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zettel -d zettelweb"]
      interval: 2s
      timeout: 5s
      retries: 10

volumes:
  pgdata:
